# Docs for the GitHub Actions SFTP Deploy action: https://github.com/marketplace/actions/ftp-sftp-file-deployer

name: Build and Deploy Umbraco App to Fasthosts

on:
  push:
    branches:
      - main
    # The 'paths' keyword now ensures this workflow only runs when files
    # under the 'src' folder are modified.
    paths:
      - 'src/**'
  # The new 'workflow_dispatch' event allows you to run this workflow manually
  # and provide custom inputs.
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Perform a dry run without actually deploying files."
        type: boolean
        required: true
        default: false
      debug-mode:
        description: "Enable verbose debug output for the SFTP transfer."
        type: boolean
        required: true
        default: false

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: Build with dotnet
        run: dotnet build --configuration Release

      - name: dotnet publish
        run: dotnet publish -c Release -o "publish" --no-self-contained

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: .net-app
          path: publish

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: .net-app
          path: ./app_publish
      
      - name: Create appsettings.json for Production
        run: |
          set +x
          # Use 'jq' to modify the JSON file.
          # We use a single, chained command to ensure all modifications are atomic.
          # - .ConnectionStrings sets the entire ConnectionStrings object.
          # - .uSync.Settings.ImportAtStartup sets the boolean value in the nested object.
          # The output is written to a temporary file and then moved to prevent
          # potential issues with in-place file editing.
          jq \
            --arg dsn "${{ secrets.UMBRACO_DB_DSN }}" \
            '.ConnectionStrings = {
                "umbracoDbDSN": $dsn,
                "umbracoDbDSN_ProviderName": "Microsoft.Data.SqlClient"
             } |
             .uSync.Settings.ImportAtStartup = true' \
            app_publish/appsettings.json > app_publish/appsettings.json.tmp && \
            mv app_publish/appsettings.json.tmp app_publish/appsettings.json
    
      # Use the new custom SFTP deployer action
      - name: SFTP Upload to Fasthosts using custom action
        # This assumes your new custom action is located at '.github/actions/sftp-deployer'
        uses: ./.github/actions/sftp-deployer
        with:
          remote-protocol: sftp
          remote-host: ${{ secrets.SFTP_HOST }}
          remote-user: ${{ secrets.SFTP_USERNAME }}
          remote-password: ${{ secrets.SFTP_PASSWORD }}
          local-path: './app_publish/'
          remote-path: '/htdocs/'
          maintenance-page-path: './app_offline.htm'
          dry-run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry-run || false }}
          debug-mode: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.debug-mode || false }}
  # New job to run Playwright smoke tests after deployment
  e2e_tests:
    runs-on: ubuntu-latest
    needs: deploy # This ensures this job runs only after the 'deploy' job completes successfully
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Install Playwright dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests against deployed URL
        env:
          PLAYWRIGHT_BASE_URL: https://theexchange-tod.com/ # Set the base URL for the tests
        run: npx playwright test
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30